{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styleEstrategias.css') }}">
{% endblock %}

{% block content %}
<div class="estrategias-container">
    <h1>Estrategias de Trading</h1>
    <div class="botones-estrategias">
        <button id="estrategiaLargoPlazoButton" class="btn-estrategia">Estrategia a Largo Plazo</button>
        <button id="estrategiaScalpingButton" class="btn-estrategia">Estrategia Scalping</button>
    </div>

    <div id="seleccionarParametros" class="seleccionar-parametros" style="display: none;">
        <div class="seleccionar-indice">
            <label for="indice">Selecciona el índice a analizar:</label>
            <select id="indice" name="indice">
                {% for key, value in indices_sinteticos.items() %}
                    <option value="{{ key }}">{{ value }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="seleccionar-temporalidad">
            <label for="temporalidad">Selecciona la temporalidad:</label>
            <select id="temporalidad" name="temporalidad">
                {% for temporalidad in temporalidades %}
                    <option value="{{ temporalidad.value }}">{{ temporalidad.label }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="ejecutarButton" class="btn-ejecutar">Ejecutar Estrategia</button>
    </div>

    <!-- Mostrar loading spinner mientras se realiza el análisis -->
    <div id="loading" class="loading-spinner" style="display: none;">
        <p>Se están realizando los análisis, por favor espere...</p>
    </div>

    <!-- Mostrar oportunidades encontradas después del análisis -->
    <div id="oportunidadesContainer" class="oportunidades-container" style="display: none;">
        <!-- Aquí se mostrarán las oportunidades una vez que se complete el análisis -->
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let endpoint = "";  // Variable para guardar el endpoint correcto

        // Mostrar el formulario de selección de parámetros según la estrategia seleccionada
        $("#estrategiaLargoPlazoButton").click(function() {
            $("#seleccionarParametros").show();
            endpoint = "/ejecutar_estrategias";  // Endpoint para la estrategia a largo plazo
        });

        $("#estrategiaScalpingButton").click(function() {
            $("#seleccionarParametros").show();
            endpoint = "/ejecutar_estrategia_scalping_hybrid";  // Endpoint para la estrategia scalping
        });

        // Ejecutar la estrategia seleccionada
        $("#ejecutarButton").click(function() {
            if (endpoint === "") {
                alert("Por favor selecciona una estrategia primero.");
                return;
            }

            // Mostrar mensaje de carga
            $("#loading").show();
            $("#oportunidadesContainer").hide();
            $("#oportunidadesContainer").empty();

            // Obtener los datos seleccionados
            let indiceSeleccionado = $("#indice").val();
            let temporalidadSeleccionada = $("#temporalidad").val();

            // Enviar solicitud POST al endpoint correspondiente
            $.post(endpoint, {
                indice: indiceSeleccionado,
                temporalidad: temporalidadSeleccionada
            }, function(data) {
                // Dar un tiempo de espera simulado para la ejecución del análisis
                setTimeout(function() {
                    $.get("/resultado_estrategias", function(response) {
                        // Ocultar mensaje de carga y mostrar contenedor de oportunidades
                        $("#loading").hide();
                        $("#oportunidadesContainer").show();

                        // Mostrar resultados
                        if (response.resultados && response.resultados.length > 0) {
                            response.resultados.forEach(function(oportunidad) {
                                let oportunidadHTML = `
                                    <div class="oportunidad">
                                        <h2>${oportunidad.strategy_name}</h2>
                                        <p><strong>Activo:</strong> ${oportunidad.asset}</p>
                                        <p><strong>Punto de Entrada:</strong> ${oportunidad.entry_point || "Valor predeterminado utilizado"}</p>
                                        <p><strong>Stop Loss:</strong> ${oportunidad.stop_loss || "Valor predeterminado utilizado"}</p>
                                        <p><strong>Take Profit:</strong> ${oportunidad.take_profit || "Valor predeterminado utilizado"}</p>
                                        <p><strong>Win Rate:</strong> ${oportunidad.win_rate}%</p>
                                        <p><strong>Fecha:</strong> ${oportunidad.timestamp}</p>
                                        <p>${oportunidad.message}</p>
                                    </div>
                                `;
                                $("#oportunidadesContainer").append(oportunidadHTML);
                            });
                        } else {
                            $("#oportunidadesContainer").html("<p>No se encontraron oportunidades.</p>");
                        }
                    }).fail(function(error) {
                        console.error("Error al obtener los resultados:", error);
                        $("#loading").hide();
                        $("#oportunidadesContainer").html("<p>Error al obtener los resultados. Intente nuevamente.</p>");
                    });
                }, 5000);
            }).fail(function(error) {
                console.error("Error en la ejecución de la estrategia:", error);
                $("#loading").hide();
                $("#oportunidadesContainer").html("<p>Error al ejecutar la estrategia. Intente nuevamente.</p>");
            });
        });
    });
</script>
{% endblock %}
