{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styleEstrategias.css') }}">
{% endblock %}

{% block content %}
<div class="estrategias-container">
    <h1>Estrategias de Trading</h1>
    <div class="seleccionar-indice">
        <label for="indice">Selecciona el índice a analizar:</label>
        <select id="indice" name="indice">
            {% for key, value in indices_sinteticos.items() %}
                <option value="{{ key }}">{{ value }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="seleccionar-temporalidad">
        <label for="temporalidad">Selecciona la temporalidad:</label>
        <select id="temporalidad" name="temporalidad">
            <option value="1">1 Minuto</option>
            <option value="5">5 Minutos</option>
            <option value="15">15 Minutos</option>
            <option value="30">30 Minutos</option>
            <option value="60">1 Hora</option>
        </select>
    </div>
    <button id="ejecutarButton" class="btn-ejecutar">Ejecutar Estrategias</button>

    <!-- Mostrar loading spinner mientras se realiza el análisis -->
    <div id="loading" class="loading-spinner" style="display: none;">
        <p>Se están realizando los análisis, por favor espere...</p>
    </div>

    <!-- Mostrar oportunidades encontradas después del análisis -->
    <div id="oportunidadesContainer" class="oportunidades-container" style="display: none;">
        <!-- Aquí se mostrarán las oportunidades una vez que se complete el análisis -->
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $("#ejecutarButton").click(function() {
            // Mostrar mensaje de carga
            $("#loading").show();
            $("#oportunidadesContainer").hide();
            $("#oportunidadesContainer").empty();

            // Obtener el índice y la temporalidad seleccionados
            let indiceSeleccionado = $("#indice").val();
            let temporalidadSeleccionada = $("#temporalidad").val();

            $.post("/ejecutar_estrategias", {indice: indiceSeleccionado, temporalidad: temporalidadSeleccionada}, function(data) {
                // Dar un tiempo de espera simulado para la ejecución del análisis
                setTimeout(function() {
                    $.get("/resultado_estrategias", function(response) {
                        // Ocultar mensaje de carga y mostrar contenedor de oportunidades
                        $("#loading").hide();
                        $("#oportunidadesContainer").show();

                        // Si hay oportunidades, mostrarlas. Si no, mostrar mensaje de "No se encontraron oportunidades"
                        if (response.resultados.length > 0) {
                            response.resultados.forEach(function(oportunidad) {
                                if (oportunidad.status && oportunidad.status === "No se encontró oportunidad") {
                                    $("#oportunidadesContainer").append(`<div class="oportunidad"><h2>${oportunidad.strategy_name}</h2><p>No se encontró oportunidad.</p></div>`);
                                } else {
                                    $("#oportunidadesContainer").append(`
                                        <div class="oportunidad">
                                            <h2>${oportunidad.strategy_name}</h2>
                                            <p><strong>Activo:</strong> ${oportunidad.asset}</p>
                                            <p><strong>Punto de Entrada:</strong> ${oportunidad.entry_point}</p>
                                            <p><strong>Stop Loss:</strong> ${oportunidad.stop_loss}</p>
                                            <p><strong>Take Profit:</strong> ${oportunidad.take_profit}</p>
                                            <p><strong>Win Rate:</strong> ${oportunidad.win_rate}%</p>
                                            <p><strong>Fecha:</strong> ${oportunidad.timestamp}</p>
                                        </div>
                                    `);
                                }
                            });
                        } else {
                            $("#oportunidadesContainer").html("<p>No se encontraron oportunidades.</p>");
                        }
                    });
                }, 5000);
            });
        });
    });
</script>
{% endblock %}
